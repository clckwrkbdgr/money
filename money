#!/bin/bash
DATAFILE=~/money.csv

usage() {
	cat <<EOF
Simple finance tracking application.
Usage: money <amount> <name>
       money -i
Options:
    -i -  Interactive mode. Reads records from stdin in form <amount> <name>,
          one for each line.
Interactive mode commands:
    group NAME - start record group with name NAME. Each record will have the
                 same prefix 'NAME: '. Groups cannot be nested, each statement
                 will restart group.
    end -        end group mode.
EOF
}

add_record() {
	DATE=$(date +%FT%T)
	AMOUNT=$1
	shift
	NAME=$*

	if echo $AMOUNT | grep -q '[-+][0-9]\+[.][0-9]\{2\}'; then
		true;
	else
		echo 'Amount should be in form `*XXXXXX.CC`, where `*` should be either `+` for income or `-` for outcome.'
		return 1
	fi

	echo -e "${DATE},${AMOUNT},${NAME}" >> "$DATAFILE"
}

if [ "$1" == '-i' ]; then
	group=''
	while read command; do
		if echo "$command" | grep -q '^group .'; then
			group="$(echo "$command" | sed 's/^group //'): "
		elif echo "$command" | grep -q '^end$'; then
			group=''
		else
			amount=$(echo "$command" | sed 's/^\([^ ]\+\) .*/\1/')
			name=$(echo "$command" | sed 's/^[^ ]\+ *//')
			add_record $amount "${group}${name}"
		fi
	done
elif [ "$1" == "--help" ]; then
	usage
elif [ -z "$2" ]; then
	usage
	exit 1
else
	add_record "$@"
fi
